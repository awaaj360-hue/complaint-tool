<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complaint Management Tool</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel to transpile JSX in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        // --- Import Firebase modules ---
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js';
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from 'https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js';
        import { getFirestore, collection, doc, onSnapshot, addDoc, updateDoc, deleteDoc, query, setDoc, where, getDocs, writeBatch } from 'https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js';

        // --- Icon Components ---
        const Icon = ({ children, className, title }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} title={title}>
                {children}
            </svg>
        );
        const Plus = (props) => <Icon {...props}><path d="M5 12h14"/><path d="M12 5v14"/></Icon>;
        const Search = (props) => <Icon {...props}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></Icon>;
        const Edit = (props) => <Icon {...props}><path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></Icon>;
        const Trash2 = (props) => <Icon {...props}><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></Icon>;
        const MessageSquare = (props) => <Icon {...props}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></Icon>;
        const X = (props) => <Icon {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></Icon>;
        const Download = (props) => <Icon {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></Icon>;
        const Upload = (props) => <Icon {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></Icon>;
        const Archive = (props) => <Icon {...props}><path d="M21 8v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8"/><path d="M10 12h4"/><path d="M22 4H2v4h20V4Z"/></Icon>;
        const ClipboardList = (props) => <Icon {...props}><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></Icon>;
        const Activity = (props) => <Icon {...props}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></Icon>;
        const CheckCircle = (props) => <Icon {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></Icon>;
        const Clock = (props) => <Icon {...props}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></Icon>;
        const Users = (props) => <Icon {...props}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></Icon>;
        const User = (props) => <Icon {...props}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></Icon>;
        const LogOut = (props) => <Icon {...props}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></Icon>;

        const { useState, useEffect, useMemo, useRef } = React;

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBRjEjfgm8Qzm9NtzjEZlVf8SLN22qK94U",
            authDomain: "compl-92104.firebaseapp.com",
            projectId: "compl-92104",
            storageBucket: "compl-92104.firebasestorage.app",
            messagingSenderId: "702508138592",
            appId: "1:702508138592:web:ef5274f6d7629a2f948305",
            measurementId: "G-4FKLXTNXDB"
        };
        const appId = 'complaint-tool-shared';
        const ADMIN_EMAIL = 'awaaj360@gmail.com';

        const initialFormState = {
            description: '',
            projectImpact: '', priority: '',
            openDate: new Date().toISOString().split('T')[0],
            closeDate: '', complaintGivenBy: '', assignedTo: '', department: '',
            status: 'Open', 
            comments: 'Please resolve issue and update ASAP, ',
            tower: '', floor: '', location: ''
        };
        
        // --- Helper Function to format time duration ---
        function formatDuration(ms) {
            if (ms < 0) ms = 0;
            const days = Math.floor(ms / (1000 * 60 * 60 * 24));
            ms %= (1000 * 60 * 60 * 24);
            const hours = Math.floor(ms / (1000 * 60 * 60));
            ms %= (1000 * 60 * 60);
            const minutes = Math.floor(ms / (1000 * 60));
            
            let str = "";
            if (days > 0) str += `${days}d `;
            if (hours > 0) str += `${hours}h `;
            if (minutes > 0 || (days === 0 && hours === 0)) str += `${minutes}m`;
            
            return str.trim() || "0m";
        }

        // --- Login Screen Component ---
        function LoginScreen({ auth }) {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');

            const handleLogin = async (e) => {
                e.preventDefault();
                setError('');
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (err) {
                    setError("Failed to log in. Please check your email and password.");
                    console.error(err);
                }
            };

            return (
                <div className="flex items-center justify-center min-h-screen bg-gray-100">
                    <div className="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md">
                        <h2 className="text-2xl font-bold text-center text-gray-800">Login to Complaint Tool</h2>
                        <form onSubmit={handleLogin} className="space-y-6">
                            <div>
                                <label htmlFor="email" className="text-sm font-medium text-gray-700">Email</label>
                                <input id="email" type="email" value={email} onChange={e => setEmail(e.target.value)} required className="w-full px-3 py-2 mt-1 border rounded-lg" />
                            </div>
                            <div>
                                <label htmlFor="password" className="text-sm font-medium text-gray-700">Password</label>
                                <input id="password" type="password" value={password} onChange={e => setPassword(e.target.value)} required className="w-full px-3 py-2 mt-1 border rounded-lg" />
                            </div>
                            {error && <p className="text-sm text-red-600">{error}</p>}
                            <button type="submit" className="w-full px-4 py-2 font-bold text-white bg-blue-600 rounded-lg hover:bg-blue-700">Log In</button>
                        </form>
                    </div>
                </div>
            );
        }
        
        // --- Dashboard Stats Component ---
        function DashboardStats({ stats }) {
            return (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div className="bg-white p-6 rounded-xl shadow-lg flex items-center justify-between transform hover:scale-105 transition-transform duration-300">
                        <div>
                            <p className="text-sm font-medium text-gray-500">Total Complaints</p>
                            <p className="text-4xl font-bold text-gray-800">{stats.total}</p>
                        </div>
                        <div className="bg-blue-100 p-4 rounded-full"><ClipboardList className="h-8 w-8 text-blue-600" /></div>
                    </div>
                    <div className="bg-white p-6 rounded-xl shadow-lg flex items-center justify-between transform hover:scale-105 transition-transform duration-300">
                        <div>
                            <p className="text-sm font-medium text-gray-500">On-Going</p>
                            <p className="text-4xl font-bold text-orange-500">{stats.ongoing}</p>
                        </div>
                        <div className="bg-orange-100 p-4 rounded-full"><Activity className="h-8 w-8 text-orange-500" /></div>
                    </div>
                    <div className="bg-white p-6 rounded-xl shadow-lg flex items-center justify-between transform hover:scale-105 transition-transform duration-300">
                        <div>
                            <p className="text-sm font-medium text-gray-500">Total Closed</p>
                            <p className="text-4xl font-bold text-green-500">{stats.closed}</p>
                        </div>
                         <div className="bg-green-100 p-4 rounded-full"><CheckCircle className="h-8 w-8 text-green-500" /></div>
                    </div>
                    <div className="bg-white p-6 rounded-xl shadow-lg flex items-center justify-between transform hover:scale-105 transition-transform duration-300">
                        <div>
                            <p className="text-sm font-medium text-gray-500">Avg. Resolution Time</p>
                            <p className="text-4xl font-bold text-purple-500">{stats.avgResolutionTime}</p>
                        </div>
                         <div className="bg-purple-100 p-4 rounded-full"><Clock className="h-8 w-8 text-purple-500" /></div>
                    </div>
                </div>
            );
        }

        // --- Complaint Form Component ---
        function ComplaintForm({ formData, setFormData, onSave, listData }) {
            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!formData.description || !formData.openDate || !formData.status) return;
                onSave(formData);
            };
            
            const handleClear = () => {
                setFormData(initialFormState);
            };

            return (
                <div className="bg-white p-6 rounded-lg shadow-sm mb-6">
                    <h2 className="text-xl font-bold text-gray-800 mb-4">{formData.id ? `Edit Complaint: ${formData.id}` : 'Add New Complaint'}</h2>
                    <form onSubmit={handleSubmit}>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div className="md:col-span-2 lg:col-span-4">
                                <label htmlFor="description" className="block text-sm font-medium text-gray-700 mb-1">Description*</label>
                                <textarea id="description" name="description" value={formData.description} onChange={handleChange} rows="2" className="w-full p-2 border rounded-lg" required placeholder="Please enter the full complaint details here..."></textarea>
                            </div>
                            <div>
                                <label htmlFor="tower" className="block text-sm font-medium text-gray-700 mb-1">Tower</label>
                                <select id="tower" name="tower" value={formData.tower} onChange={handleChange} className="w-full p-2 border rounded-lg">
                                    <option value="">Select Tower</option>
                                    {listData.towers.map(t => <option key={t} value={t}>{t}</option>)}
                                </select>
                            </div>
                             <div>
                                <label htmlFor="floor" className="block text-sm font-medium text-gray-700 mb-1">Floor</label>
                                <select id="floor" name="floor" value={formData.floor} onChange={handleChange} className="w-full p-2 border rounded-lg">
                                    <option value="">Select Floor</option>
                                    {listData.floors.map(f => <option key={f} value={f}>{f}</option>)}
                                </select>
                            </div>
                            <div className="md:col-span-2">
                                <label htmlFor="location" className="block text-sm font-medium text-gray-700 mb-1">Particular Location</label>
                                <input type="text" id="location" name="location" value={formData.location} onChange={handleChange} className="w-full p-2 border rounded-lg" placeholder="e.g., Flat 101, Office 2B..."/>
                            </div>
                            <div>
                                <label htmlFor="openDate" className="block text-sm font-medium text-gray-700 mb-1">Open Date*</label>
                                <input type="date" id="openDate" name="openDate" value={formData.openDate} onChange={handleChange} className="w-full p-2 border rounded-lg" required />
                            </div>
                            <div>
                                <label htmlFor="status" className="block text-sm font-medium text-gray-700 mb-1">Status*</label>
                                <select id="status" name="status" value={formData.status} onChange={handleChange} className="w-full p-2 border rounded-lg" required>
                                    {listData.statuses.map(s => <option key={s} value={s}>{s}</option>)}
                                </select>
                            </div>
                            {formData.status === 'Closed' && (
                                <div>
                                    <label htmlFor="closeDate" className="block text-sm font-medium text-gray-700 mb-1">Close Date</label>
                                    <input type="date" id="closeDate" name="closeDate" value={formData.closeDate} onChange={handleChange} className="w-full p-2 border rounded-lg" />
                                </div>
                            )}
                            <div>
                                <label htmlFor="priority" className="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                                <select id="priority" name="priority" value={formData.priority} onChange={handleChange} className="w-full p-2 border rounded-lg">
                                    <option value="">Select Priority</option>
                                    {listData.priorities.map(p => <option key={p} value={p}>{p}</option>)}
                                </select>
                            </div>
                            <div>
                                <label htmlFor="complaintGivenBy" className="block text-sm font-medium text-gray-700 mb-1">Complaint Given by</label>
                                <input type="text" id="complaintGivenBy" name="complaintGivenBy" value={formData.complaintGivenBy} onChange={handleChange} className="w-full p-2 border rounded-lg" placeholder="Enter name..."/>
                            </div>
                            <div>
                                <label htmlFor="assignedTo" className="block text-sm font-medium text-gray-700 mb-1">Assigned to Me</label>
                                <select id="assignedTo" name="assignedTo" value={formData.assignedTo} onChange={handleChange} className="w-full p-2 border rounded-lg">
                                    <option value="">Select Supervisor</option>
                                    {listData.supervisors.map(s => <option key={s} value={s}>{s}</option>)}
                                </select>
                            </div>
                            <div>
                                <label htmlFor="department" className="block text-sm font-medium text-gray-700 mb-1">Department</label>
                                <select id="department" name="department" value={formData.department} onChange={handleChange} className="w-full p-2 border rounded-lg">
                                    <option value="">Select Department</option>
                                    {listData.departments.map(d => <option key={d} value={d}>{d}</option>)}
                                </select>
                            </div>
                            <div className="md:col-span-2 lg:col-span-4">
                                <label htmlFor="comments" className="block text-sm font-medium text-gray-700 mb-1">Comments</label>
                                <textarea id="comments" name="comments" value={formData.comments} onChange={handleChange} rows="2" className="w-full p-2 border rounded-lg"></textarea>
                            </div>
                        </div>
                        <div className="flex items-center justify-end gap-4 mt-4">
                            <button onClick={handleClear} type="button" className="px-4 py-2 border rounded-lg text-gray-700 hover:bg-gray-100">Clear</button>
                            <button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save Complaint</button>
                        </div>
                    </form>
                </div>
            );
        }


        // --- Main Tool Component ---
        function ComplaintTool({ user, auth }) {
            const [db, setDb] = useState(null);
            const [complaints, setComplaints] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [formData, setFormData] = useState(initialFormState);
            const isAdmin = user.email === ADMIN_EMAIL;
            
            const listData = {
                projectImpacts: ['High', 'Medium', 'Low'],
                priorities: ['Critical', 'High', 'Medium', 'Low'],
                supervisors: ['Rajan', 'Sudhir', 'Rahul', 'Vishal', 'Doleep', 'Other'],
                departments: ['IT', 'Operations', 'HR', 'Finance'],
                statuses: ['Open', 'In Progress', 'Closed', 'On Hold'],
                towers: ['Tower 1', 'Tower 2', 'Tower 3', 'Tower 4', 'Tower 5', 'Tower 6'],
                floors: ['Basement 1', 'Basement 2', 'Ground Floor', '1st Floor', '2nd Floor', '3rd Floor', '4th Floor', '5th Floor', '6th Floor', 'Terrace']
            };
            
            const [filterBy, setFilterBy] = useState('ALL');
            const [searchTerm, setSearchTerm] = useState('');
            const [sortBy, setSortBy] = useState('createdAt');
            const [sortOrder, setSortOrder] = useState('desc');

            const [whatsAppInfo, setWhatsAppInfo] = useState({ isOpen: false, message: '', link: '' });
            const [commentModalInfo, setCommentModalInfo] = useState({ isOpen: false, complaint: null });

            useEffect(() => {
                const firestoreDb = getFirestore(initializeApp(firebaseConfig));
                setDb(firestoreDb);
            }, []);

            useEffect(() => {
                if (!db) return;

                setIsLoading(true);
                const complaintsCollectionPath = `artifacts/${appId}/public/data/complaints`;
                const q = query(collection(db, complaintsCollectionPath));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const complaintsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setComplaints(complaintsData);
                    setIsLoading(false);
                });

                return () => unsubscribe();
            }, [db]);

            const dashboardStats = useMemo(() => {
                const total = complaints.length;
                const closedComplaints = complaints.filter(c => c.status === 'Closed');
                const closedCount = closedComplaints.length;
                const ongoing = total - closedCount;

                let totalResolutionTime = 0;
                const resolvedComplaints = closedComplaints.filter(c => c.openDate && c.closeDate);
                resolvedComplaints.forEach(c => {
                    totalResolutionTime += new Date(c.closeDate) - new Date(c.openDate);
                });
                const avgTime = resolvedComplaints.length > 0 ? totalResolutionTime / resolvedComplaints.length : 0;

                return {
                    total: total,
                    closed: closedCount,
                    ongoing: ongoing,
                    avgResolutionTime: formatDuration(avgTime)
                };
            }, [complaints]);

            const filteredAndSortedComplaints = useMemo(() => {
                let result = [...complaints];
                if (filterBy !== 'ALL' && searchTerm) {
                    result = result.filter(c => {
                        const value = c[filterBy] ? String(c[filterBy]).toLowerCase() : '';
                        return value.includes(searchTerm.toLowerCase());
                    });
                }
                result.sort((a, b) => {
                    let valA = a[sortBy];
                    let valB = b[sortBy];
                    if (sortBy === 'openDate' || sortBy === 'closeDate' || sortBy === 'createdAt') {
                        valA = valA ? new Date(valA).getTime() : 0;
                        valB = valB ? new Date(valB).getTime() : 0;
                    }
                    if (valA < valB) return sortOrder === 'asc' ? -1 : 1;
                    if (valA > valB) return sortOrder === 'asc' ? 1 : -1;
                    return 0;
                });
                return result;
            }, [complaints, filterBy, searchTerm, sortBy, sortOrder]);

            const handleSaveComplaint = async (dataToSave) => {
                const complaintsCollectionPath = `artifacts/${appId}/public/data/complaints`;
                if (dataToSave.id) {
                    const docRef = doc(db, complaintsCollectionPath, dataToSave.id);
                    const { id, ...updatedData } = dataToSave;
                    await updateDoc(docRef, updatedData);
                } else {
                    const now = new Date();
                    const dateStr = now.getDate().toString().padStart(2, '0') + (now.getMonth() + 1).toString().padStart(2, '0') + now.getFullYear();
                    const timeStr = now.getHours().toString().padStart(2, '0') + now.getMinutes().toString().padStart(2, '0') + now.getSeconds().toString().padStart(2, '0');
                    const customId = `CB_${dateStr}_${timeStr}`;
                    
                    const docRef = doc(db, complaintsCollectionPath, customId);
                    await setDoc(docRef, {
                        ...dataToSave,
                        id: customId,
                        createdAt: new Date().toISOString()
                    });
                }
                setFormData(initialFormState);
            };

            const handleStatusChange = async (complaint, newStatus) => {
                if (!isAdmin && newStatus === 'Closed') {
                    setCommentModalInfo({ isOpen: true, complaint: complaint });
                } else {
                    const docRef = doc(db, `artifacts/${appId}/public/data/complaints`, complaint.id);
                    await updateDoc(docRef, { status: newStatus });
                }
            };

            const handleCloseWithComment = async (complaint, newComment) => {
                const docRef = doc(db, `artifacts/${appId}/public/data/complaints`, complaint.id);
                await updateDoc(docRef, { 
                    status: 'Closed',
                    comments: complaint.comments ? `${complaint.comments}\nResolution: ${newComment}` : `Resolution: ${newComment}`,
                    closeDate: new Date().toISOString()
                });
                setCommentModalInfo({ isOpen: false, complaint: null });
            };

            const handleDeleteComplaint = async (id) => {
                if (window.confirm("Are you sure you want to delete this complaint?")) {
                    const docRef = doc(db, `artifacts/${appId}/public/data/complaints`, id);
                    await deleteDoc(docRef);
                }
            };
            
            const handleEditComplaint = (complaint) => {
                setFormData({
                    ...initialFormState,
                    ...complaint,
                    openDate: complaint.openDate ? new Date(complaint.openDate).toISOString().split('T')[0] : '',
                    closeDate: complaint.closeDate ? new Date(complaint.closeDate).toISOString().split('T')[0] : '',
                });
                window.scrollTo(0, 0);
            };
            
            const handleWhatsAppGroup = (complaint) => {
                const groupInviteLink = 'whatsapp://chat?code=LnmcdjlhU8CGoX8LK8V3KT';
                const locationParts = [complaint.tower, complaint.floor, complaint.location].filter(Boolean);
                const locationString = locationParts.length > 0 ? locationParts.join(', ') : 'N/A';
                const message = `*Complaint Details for CBRE & ICON Axis team*\n\n` +
                                `*ID:* ${complaint.id}\n` +
                                `*Description:* ${complaint.description}\n` +
                                `*Location:* ${locationString}\n`+
                                `*Priority:* ${complaint.priority || 'N/A'}\n` +
                                `*Status:* ${complaint.status}\n` +
                                `*Complaint Given by:* ${complaint.complaintGivenBy || 'N/A'}\n` +
                                `*Assigned To:* ${complaint.assignedTo || 'N/A'}\n` +
                                `*Department:* ${complaint.department || 'N/A'}\n` +
                                `*Open Date:* ${new Date(complaint.openDate).toLocaleDateString()}\n\n` +
                                `_Please review the complaint._`;
                setWhatsAppInfo({ isOpen: true, message: message, link: groupInviteLink });
            };
            
            if (isLoading) {
                return <div className="flex items-center justify-center h-screen bg-gray-100"><div className="text-xl font-semibold">Loading Data...</div></div>;
            }

            return (
                <div className="bg-gray-100 min-h-screen font-sans p-4 sm:p-6 lg:p-8">
                    <div className="max-w-7xl mx-auto">
                        <header className="mb-6 flex justify-between items-center">
                            <div>
                                <h1 className="text-3xl font-bold text-gray-800">Complaint Management Tool</h1>
                                <p className="text-gray-500">Logged in as: {user.email}</p>
                            </div>
                            <button onClick={() => signOut(auth)} className="p-2 rounded-lg flex items-center gap-2 bg-red-500 text-white shadow hover:bg-red-600">
                                <LogOut size={18} /> Sign Out
                            </button>
                        </header>

                        <DashboardStats stats={dashboardStats} />
                        
                        {isAdmin && <ComplaintForm formData={formData} setFormData={setFormData} onSave={handleSaveComplaint} listData={listData} />}

                        <div className="bg-white rounded-lg shadow-sm overflow-x-auto">
                            <table className="w-full text-left">
                                <thead className="bg-gray-50 border-b">
                                    <tr>
                                        {['Complaint ID', 'Description', 'Location', 'Status', 'Open Date', 'Assigned To', 'Comments', isAdmin ? 'Actions' : null].filter(Boolean).map(h => (
                                            <th key={h} className="p-4 text-sm font-semibold text-gray-600">{h}</th>
                                        ))}
                                    </tr>
                                </thead>
                                <tbody>
                                    {filteredAndSortedComplaints.map(c => (
                                        <tr key={c.id} className="border-b hover:bg-gray-50">
                                            <td className="p-4 text-sm text-gray-500 font-mono">{c.id}</td>
                                            <td className="p-4 text-sm text-gray-800 max-w-xs truncate">{c.description}</td>
                                            <td className="p-4 text-sm text-gray-600">{[c.tower, c.floor, c.location].filter(Boolean).join(', ')}</td>
                                            <td className="p-4 text-sm">
                                                <select value={c.status} onChange={(e) => handleStatusChange(c, e.target.value)} className="p-1 border rounded-lg bg-gray-50" disabled={!isAdmin && c.status === 'Closed'}>
                                                    {listData.statuses.map(s => <option key={s} value={s}>{s}</option>)}
                                                </select>
                                            </td>
                                            <td className="p-4 text-sm text-gray-600">{c.openDate ? new Date(c.openDate).toLocaleDateString() : 'Invalid Date'}</td>
                                            <td className="p-4 text-sm text-gray-600">{c.assignedTo}</td>
                                            <td className="p-4 text-sm text-gray-600 max-w-xs whitespace-pre-wrap">{c.comments}</td>
                                            {isAdmin && (
                                                <td className="p-4">
                                                    <div className="flex items-center gap-2">
                                                        <button onClick={() => handleWhatsAppGroup(c)} className="p-2 text-green-600 hover:bg-green-100 rounded-full" title="Send to WhatsApp Group"><MessageSquare size={18} /></button>
                                                        <button onClick={() => handleEditComplaint(c)} className="p-2 text-blue-600 hover:bg-blue-100 rounded-full" title="Edit Complaint"><Edit size={18} /></button>
                                                        <button onClick={() => handleDeleteComplaint(c.id)} className="p-2 text-red-600 hover:bg-red-100 rounded-full" title="Delete Complaint"><Trash2 size={18} /></button>
                                                    </div>
                                                </td>
                                            )}
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                             {filteredAndSortedComplaints.length === 0 && (
                                <div className="text-center p-8 text-gray-500">Koi complaint nahi mili.</div>
                            )}
                        </div>
                    </div>

                    {whatsAppInfo.isOpen && <WhatsAppMessageModal 
                        message={whatsAppInfo.message} 
                        groupLink={whatsAppInfo.link}
                        onClose={() => setWhatsAppInfo({ isOpen: false, message: '', link: '' })} 
                    />}
                    {commentModalInfo.isOpen && <ResolutionCommentModal
                        complaint={commentModalInfo.complaint}
                        onClose={() => setCommentModalInfo({ isOpen: false, complaint: null })}
                        onSave={handleCloseWithComment}
                    />}
                </div>
            );
        }
        
        // --- Main App Controller ---
        function App() {
            const [user, setUser] = useState(null);
            const [auth, setAuth] = useState(null);
            const [isLoading, setIsLoading] = useState(true);

            useEffect(() => {
                const app = initializeApp(firebaseConfig);
                const authInstance = getAuth(app);
                setAuth(authInstance);

                const unsubscribe = onAuthStateChanged(authInstance, (user) => {
                    setUser(user);
                    setIsLoading(false);
                });

                return () => unsubscribe();
            }, []);

            if (isLoading) {
                return <div className="flex items-center justify-center h-screen bg-gray-100"><div className="text-xl font-semibold">Loading App...</div></div>;
            }

            return user ? <ComplaintTool user={user} auth={auth} /> : <LoginScreen auth={auth} />;
        }

        function WhatsAppMessageModal({ message, groupLink, onClose }) {
            const textAreaRef = useRef(null);
            useEffect(() => {
                if (textAreaRef.current) {
                    textAreaRef.current.select();
                }
            }, []);
            const handleOpenWhatsApp = () => {
                window.location.href = groupLink;
                onClose();
            };
            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-lg">
                        <header className="flex items-center justify-between p-4 border-b">
                            <h3 className="text-lg font-medium text-gray-900">Send Complaint to WhatsApp</h3>
                            <button onClick={onClose} className="p-2 hover:bg-gray-100 rounded-full"><X size={20} /></button>
                        </header>
                        <div className="p-6">
                            <p className="text-sm text-gray-600 mb-2">**Step 1:** The message below is selected. Please copy it now (Ctrl+C or Command+C).</p>
                            <textarea ref={textAreaRef} readOnly value={message} className="w-full h-40 p-2 border rounded-lg bg-gray-50 font-mono text-sm" />
                            <p className="text-sm text-gray-600 mt-4 mb-2">**Step 2:** After copying, click the button below to open WhatsApp and paste the message.</p>
                        </div>
                        <div className="bg-gray-50 px-6 py-3 flex justify-end gap-4">
                            <button type="button" className="px-4 py-2 border rounded-lg text-gray-700 hover:bg-gray-100" onClick={onClose}>Cancel</button>
                            <button type="button" className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700" onClick={handleOpenWhatsApp}>Open WhatsApp</button>
                        </div>
                    </div>
                </div>
            );
        }

        function ResolutionCommentModal({ complaint, onClose, onSave }) {
            const [comment, setComment] = useState('');
            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-lg">
                        <header className="flex items-center justify-between p-4 border-b">
                            <h3 className="text-lg font-medium text-gray-900">Add Resolution Comment</h3>
                            <button onClick={onClose} className="p-2 hover:bg-gray-100 rounded-full"><X size={20} /></button>
                        </header>
                        <div className="p-6">
                            <p className="text-sm text-gray-600 mb-2">Please provide a comment before closing the complaint.</p>
                            <textarea
                                value={comment}
                                onChange={(e) => setComment(e.target.value)}
                                className="w-full h-24 p-2 border rounded-lg"
                                placeholder="Enter resolution details here..."
                                autoFocus
                            />
                        </div>
                        <div className="bg-gray-50 px-6 py-3 flex justify-end gap-4">
                            <button type="button" className="px-4 py-2 border rounded-lg text-gray-700 hover:bg-gray-100" onClick={onClose}>Cancel</button>
                            <button type="button" className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400" onClick={() => onSave(complaint, comment)} disabled={!comment.trim()}>
                                Save & Close Complaint
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>

</body>
</html>
