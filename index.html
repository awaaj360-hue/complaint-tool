<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Management Tool</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel to transpile JSX in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- XLSX Library for Excel Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        // --- Import Firebase modules ---
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js';
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from 'https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js';
        import { getFirestore, collection, doc, onSnapshot, updateDoc, setDoc, deleteDoc, writeBatch } from 'https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js';

        // --- Icon Components ---
        const Icon = ({ children, className, title }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} title={title}>
                {children}
            </svg>
        );
        const Plus = (props) => <Icon {...props}><path d="M5 12h14"/><path d="M12 5v14"/></Icon>;
        const Search = (props) => <Icon {...props}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></Icon>;
        const Edit = (props) => <Icon {...props}><path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></Icon>;
        const MessageSquare = (props) => <Icon {...props}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></Icon>;
        const X = (props) => <Icon {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></Icon>;
        const ClipboardList = (props) => <Icon {...props}><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></Icon>;
        const Activity = (props) => <Icon {...props}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></Icon>;
        const CheckCircle = (props) => <Icon {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></Icon>;
        const Clock = (props) => <Icon {...props}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></Icon>;
        const Users = (props) => <Icon {...props}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></Icon>;
        const LogOut = (props) => <Icon {...props}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></Icon>;
        const FilterX = (props) => <Icon {...props}><path d="M13.013 3H2.997a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V8.988"/><path d="m17.5 2.5-5.5 5.5"/><path d="m2.5 17.5 5.5-5.5"/><path d="m17.5 17.5-5.5-5.5"/><path d="m2.5 2.5 5.5 5.5"/></Icon>;
        const Trash2 = (props) => <Icon {...props}><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></Icon>;
        const Download = (props) => <Icon {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></Icon>;
        const Archive = (props) => <Icon {...props}><path d="M21 8v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8"/><path d="M10 12h4"/><path d="M22 4H2v4h20V4Z"/></Icon>;

        const { useState, useEffect, useMemo, useRef } = React;

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBRjEjfgm8Qzm9NtzjEZlVf8SLN22qK94U",
            authDomain: "compl-92104.firebaseapp.com",
            projectId: "compl-92104",
            storageBucket: "compl-92104.firebasestorage.app",
            messagingSenderId: "702508138592",
            appId: "1:702508138592:web:ef5274f6d7629a2f948305",
            measurementId: "G-4FKLXTNXDB"
        };
        const appId = 'complaint-tool-shared';
        const ADMIN_EMAIL = 'awaaj360@gmail.com';

        const initialFormState = {
            description: '', priority: '',
            openDate: new Date().toISOString().split('T')[0],
            closeDate: '', complaintGivenBy: '', assignedTo: '',
            status: 'Open', comments: 'Please attend on priority.', // Updated default comment
            tower: '', floor: '', location: '',
            tatHours: 2,
            remindersSent: { level: 0, lastSent: null },
            nextReminderDue: null
        };
        
        function formatDuration(ms) { if (ms < 0) ms = 0; const d = Math.floor(ms / 864e5), h = Math.floor(ms / 36e5), m = Math.floor(ms / 6e4) % 60; return d > 0 ? `${d}d ${h % 24}h` : h > 0 ? `${h}h ${m}m` : `${m}m`; }
        
        // --- Login Screen --- (No changes)
        function LoginScreen({ auth }) {
            const [email, setEmail] = useState(''); const [password, setPassword] = useState(''); const [error, setError] = useState('');
            const handleLogin = async (e) => { e.preventDefault(); setError(''); try { await signInWithEmailAndPassword(auth, email, password); } catch (err) { setError("Failed to log in."); } };
            return ( <div className="flex items-center justify-center min-h-screen bg-gray-100"><div className="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md"><h2 className="text-2xl font-bold text-center text-gray-800">Login to Task Tool</h2><form onSubmit={handleLogin} className="space-y-6"><div><label htmlFor="email" className="text-sm font-medium text-gray-700">Email</label><input id="email" type="email" value={email} onChange={e => setEmail(e.target.value)} required className="w-full px-3 py-2 mt-1 border rounded-lg" /></div><div><label htmlFor="password" className="text-sm font-medium text-gray-700">Password</label><input id="password" type="password" value={password} onChange={e => setPassword(e.target.value)} required className="w-full px-3 py-2 mt-1 border rounded-lg" /></div>{error && <p className="text-sm text-red-600">{error}</p>}<button type="submit" className="w-full px-4 py-2 font-bold text-white bg-blue-600 rounded-lg hover:bg-blue-700">Log In</button></form></div></div> );
        }

        // --- Dashboard Cards ---
        const StatCard = ({ title, value, icon, gradient, onClick }) => ( <button onClick={onClick} className={`text-white p-4 rounded-xl shadow-lg flex flex-col justify-between h-full transition-all duration-300 transform hover:scale-105 hover:shadow-2xl ${gradient}`}><div className="flex justify-between items-start"><span className="font-semibold">{title}</span>{icon}</div><span className="text-4xl font-bold mt-2">{value}</span></button> );
        const AssignedToCard = ({ stats, onFilter }) => ( <div className="text-white p-4 rounded-xl shadow-lg flex flex-col h-full bg-gradient-to-br from-purple-500 to-indigo-600"><div className="flex justify-between items-start mb-2"><span className="font-semibold">Assignments Overview</span><Users className="w-7 h-7 opacity-70" /></div><div className="space-y-2 overflow-y-auto text-sm max-h-32">{stats.length > 0 ? stats.map(person => ( <button key={person.name} onClick={() => onFilter(person.name)} className="w-full text-left p-2 rounded-lg bg-white/20 hover:bg-white/30 transition-colors flex justify-between items-center"><span className="font-bold">{person.name}</span><div className="flex gap-2 text-xs"><span className="bg-orange-400 px-2 py-0.5 rounded-full">{person.ongoing} O</span><span className="bg-green-400 px-2 py-0.5 rounded-full">{person.completed} C</span></div></button> )) : <p className="opacity-70">No assignments.</p>}</div></div> );
        function DashboardStats({ stats, assignedToStats, onFilter }) { return ( <div className="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6"><StatCard title="Total Tasks" value={stats.total} icon={<ClipboardList className="w-7 h-7 opacity-70"/>} gradient="bg-gradient-to-br from-blue-400 to-blue-600" onClick={() => onFilter('ALL')} /><StatCard title="On-Going" value={stats.ongoing} icon={<Activity className="w-7 h-7 opacity-70"/>} gradient="bg-gradient-to-br from-orange-400 to-orange-600" onClick={() => onFilter('ONGOING')} /><StatCard title="Completed" value={stats.closed} icon={<CheckCircle className="w-7 h-7 opacity-70"/>} gradient="bg-gradient-to-br from-green-400 to-green-600" onClick={() => onFilter('CLOSED')} /><AssignedToCard stats={assignedToStats} onFilter={onFilter} /></div> ); }

        // --- Task Form ---
        function TaskForm({ formData, setFormData, onSave, listData }) { const handleChange = (e) => { const { name, value } = e.target; setFormData(prev => ({ ...prev, [name]: value })); }; const handleSubmit = (e) => { e.preventDefault(); if (!formData.description) return; onSave(formData); }; return ( <div className="bg-white p-4 rounded-lg shadow-sm mb-6"><h2 className="text-xl font-bold text-gray-800 mb-4">{formData.id ? `Edit Task: ${formData.id}` : 'Add New Assignment'}</h2><form onSubmit={handleSubmit}><div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"><div className="md:col-span-2 lg:col-span-4"><label htmlFor="description" className="block text-sm font-medium text-gray-700 mb-1">Description*</label><textarea id="description" name="description" value={formData.description} onChange={handleChange} rows="2" className="w-full p-2 border rounded-lg" required></textarea></div><div><label htmlFor="tower" className="block text-sm font-medium text-gray-700 mb-1">Tower</label><select id="tower" name="tower" value={formData.tower} onChange={handleChange} className="w-full p-2 border rounded-lg"><option value="">Select</option>{listData.towers.map(t => <option key={t} value={t}>{t}</option>)}</select></div><div><label htmlFor="floor" className="block text-sm font-medium text-gray-700 mb-1">Floor</label><select id="floor" name="floor" value={formData.floor} onChange={handleChange} className="w-full p-2 border rounded-lg"><option value="">Select</option>{listData.floors.map(f => <option key={f} value={f}>{f}</option>)}</select></div><div className="md:col-span-2"><label htmlFor="location" className="block text-sm font-medium text-gray-700 mb-1">Location</label><input type="text" id="location" name="location" value={formData.location} onChange={handleChange} className="w-full p-2 border rounded-lg" /></div><div><label htmlFor="openDate" className="block text-sm font-medium text-gray-700 mb-1">Open Date*</label><input type="date" id="openDate" name="openDate" value={formData.openDate} onChange={handleChange} className="w-full p-2 border rounded-lg" required /></div><div><label htmlFor="assignedTo" className="block text-sm font-medium text-gray-700 mb-1">Assigned to</label><select id="assignedTo" name="assignedTo" value={formData.assignedTo} onChange={handleChange} className="w-full p-2 border rounded-lg"><option value="">Select</option>{listData.supervisors.map(s => <option key={s} value={s}>{s}</option>)}</select></div><div><label htmlFor="tatHours" className="block text-sm font-medium text-gray-700 mb-1">Initial TAT</label><select id="tatHours" name="tatHours" value={formData.tatHours} onChange={handleChange} className="w-full p-2 border rounded-lg">{[1,2,4,8,24].map(h=><option key={h} value={h}>{h} Hour(s)</option>)}</select></div><div><label htmlFor="status" className="block text-sm font-medium text-gray-700 mb-1">Status*</label><select id="status" name="status" value={formData.status} onChange={handleChange} className="w-full p-2 border rounded-lg" required>{listData.statuses.map(s => <option key={s} value={s}>{s}</option>)}</select></div><div className="md:col-span-2 lg:col-span-4"><label htmlFor="comments" className="block text-sm font-medium text-gray-700 mb-1">Comments</label><textarea id="comments" name="comments" value={formData.comments} onChange={handleChange} rows="2" className="w-full p-2 border rounded-lg"></textarea></div></div><div className="flex items-center justify-end gap-4 mt-4"><button onClick={() => setFormData(initialFormState)} type="button" className="px-4 py-2 border rounded-lg">Clear</button><button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded-lg">Save Task</button></div></form></div> ); }

        // --- Main Tool Component ---
        function TaskTool({ user, auth }) {
            const [db, setDb] = useState(null);
            const [tasks, setTasks] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [formData, setFormData] = useState(initialFormState);
            const [taskToShare, setTaskToShare] = useState(null);
            const isAdmin = user.email === ADMIN_EMAIL;
            
            const listData = {
                supervisors: ['Rajan', 'Sudhir', 'Rahul', 'Vishal', 'Dileep', 'Other'], // Corrected name
                statuses: ['Open', 'In Progress', 'Closed', 'On Hold'],
                towers: ['Tower 1', 'Tower 2', 'Tower 3', 'Tower 4', 'Tower 5', 'Tower 6'],
                floors: ['Basement 1', 'Basement 2', 'Ground Floor', '1st Floor', '2nd Floor', '3rd Floor', '4th Floor', '5th Floor', '6th Floor', 'Terrace']
            };
            
            const [cardFilter, setCardFilter] = useState('ALL');
            const [searchTerm, setSearchTerm] = useState('');
            const [whatsAppInfo, setWhatsAppInfo] = useState({ isOpen: false, message: '' });
            const [commentModalInfo, setCommentModalInfo] = useState({ isOpen: false, task: null });

            useEffect(() => {
                const firestoreDb = getFirestore(initializeApp(firebaseConfig));
                setDb(firestoreDb);
                const collectionPath = `artifacts/${appId}/public/data/complaints`;
                const unsubscribe = onSnapshot(collection(firestoreDb, collectionPath), (snapshot) => {
                    setTasks(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    setIsLoading(false);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => { if (taskToShare) { handleWhatsAppShare(taskToShare); setTaskToShare(null); } }, [taskToShare]);

            const dashboardStats = useMemo(() => {
                const closedCount = tasks.filter(c => c.status === 'Closed').length;
                return { total: tasks.length, closed: closedCount, ongoing: tasks.length - closedCount };
            }, [tasks]);
            
            const assignedToStats = useMemo(() => {
                const stats = tasks.reduce((acc, c) => {
                    if (!c.assignedTo) return acc;
                    if (!acc[c.assignedTo]) acc[c.assignedTo] = { name: c.assignedTo, ongoing: 0, completed: 0 };
                    if (c.status === 'Closed') acc[c.assignedTo].completed += 1; else acc[c.assignedTo].ongoing += 1;
                    return acc;
                }, {});
                return Object.values(stats).sort((a, b) => (b.ongoing + b.completed) - (a.ongoing + a.completed));
            }, [tasks]);

            const filteredTasks = useMemo(() => {
                let result = [...tasks];
                if (cardFilter !== 'ALL') {
                    if (cardFilter === 'ONGOING') result = result.filter(c => c.status !== 'Closed');
                    else if (cardFilter === 'CLOSED') result = result.filter(c => c.status === 'Closed');
                    else result = result.filter(c => c.assignedTo === cardFilter);
                }
                if (searchTerm) {
                    result = result.filter(c => Object.values(c).some(val => String(val).toLowerCase().includes(searchTerm.toLowerCase())));
                }
                return result.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
            }, [tasks, cardFilter, searchTerm]);

            const handleSaveTask = async (dataToSave) => {
                const collectionPath = `artifacts/${appId}/public/data/complaints`;
                const now = new Date();
                let savedTaskData;
                if (dataToSave.id) {
                    await updateDoc(doc(db, collectionPath, dataToSave.id), dataToSave);
                    savedTaskData = dataToSave;
                } else {
                    const tatHours = Number(dataToSave.tatHours);
                    const dateStr = now.toISOString().slice(0, 10).replace(/-/g, '');
                    const timeStr = now.toTimeString().slice(0, 8).replace(/:/g, '');
                    const customId = `TSK_${dateStr}_${timeStr}`;
                    const newData = { ...dataToSave, id: customId, createdAt: now.toISOString(), remindersSent: { level: 0, lastSent: null }, nextReminderDue: new Date(now.getTime() + tatHours * 3600 * 1000).toISOString() };
                    await setDoc(doc(db, collectionPath, customId), newData);
                    savedTaskData = newData;
                }
                setFormData(initialFormState);
                setTaskToShare(savedTaskData);
            };

            const handleStatusChange = async (task, newStatus) => {
                if (newStatus === 'Closed' && !isAdmin) {
                    setCommentModalInfo({ isOpen: true, task });
                } else {
                    const updates = { status: newStatus };
                    if (newStatus === 'Closed') updates.closeDate = new Date().toISOString();
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/complaints`, task.id), updates);
                }
            };

            const handleCloseWithComment = async (task, comment) => {
                 const updates = { status: 'Closed', closeDate: new Date().toISOString(), comments: `${task.comments}\nResolution: ${comment}` };
                 await updateDoc(doc(db, `artifacts/${appId}/public/data/complaints`, task.id), updates);
                 setCommentModalInfo({ isOpen: false, task: null });
            };
            
            const handleEditTask = (task) => { setFormData({ ...initialFormState, ...task, openDate: task.openDate ? new Date(task.openDate).toISOString().split('T')[0] : '' }); window.scrollTo(0, 0); };
            const handleDeleteTask = async (id) => { if(window.confirm("Delete this task permanently?")) { await deleteDoc(doc(db, `artifacts/${appId}/public/data/complaints`, id)); } };

            const handleWhatsAppShare = (task) => { const link = 'https://wa.me/919999999999'; const location = [task.tower, task.floor, task.location].filter(Boolean).join(', '); const message = `*New work assignment*\n\n*Task ID:* ${task.id}\n*Description:* ${task.description}\n${location ? `*Location:* ${location}\n` : ''}*Assigned To:* ${task.assignedTo || 'N/A'}\n*TAT:* ${task.tatHours || 2} Hours\n\n_Please review._`; setWhatsAppInfo({ isOpen: true, message, link }); };

            const handleExport = () => {
                const dataToExport = filteredTasks.map(t => ({
                    'Task ID': t.id, 'Description': t.description, 'Location': [t.tower, t.floor, t.location].filter(Boolean).join(', '),
                    'Assigned To': t.assignedTo, 'Status': t.status, 'Open Date': t.openDate, 'Close Date': t.closeDate, 'Comments': t.comments
                }));
                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Tasks");
                XLSX.writeFile(workbook, "TaskList.xlsx");
            };

            const handleArchive = async () => {
                if (!window.confirm("Archive all closed tasks? This cannot be undone.")) return;
                const batch = writeBatch(db);
                const closedTasks = tasks.filter(t => t.status === 'Closed');
                closedTasks.forEach(task => {
                    batch.set(doc(db, `artifacts/${appId}/public/data/archived_tasks`, task.id), task);
                    batch.delete(doc(db, `artifacts/${appId}/public/data/complaints`, task.id));
                });
                await batch.commit();
                alert(`${closedTasks.length} tasks archived.`);
            };

            if (isLoading) { return <div className="flex items-center justify-center h-screen"><div className="text-xl font-semibold">Loading...</div></div>; }

            return (
                <div className="bg-gray-50 min-h-screen font-sans p-2 sm:p-4">
                    <div className="max-w-7xl mx-auto">
                        <header className="mb-4 flex justify-between items-center"><h1 className="text-2xl md:text-3xl font-bold text-gray-800">Task Management</h1><button onClick={() => signOut(auth)} className="p-2 rounded-lg flex items-center gap-2 bg-red-500 text-white"><LogOut size={18} /><span className="hidden md:inline">Sign Out</span></button></header>
                        <DashboardStats stats={dashboardStats} assignedToStats={assignedToStats} onFilter={setCardFilter} />
                        {isAdmin && <TaskForm formData={formData} setFormData={setFormData} onSave={handleSaveTask} listData={listData} />}
                        <div className="bg-white p-4 rounded-lg shadow-sm mb-4">
                            <div className="flex flex-wrap items-center justify-between gap-4">
                                <div className="flex items-center gap-2">
                                    <h3 className="text-lg font-semibold text-gray-700">Task List</h3>
                                    {isAdmin && <button onClick={handleExport} className="flex items-center gap-2 px-3 py-1.5 text-sm bg-blue-100 text-blue-700 rounded-lg"><Download size={16}/> Export</button>}
                                    {isAdmin && dashboardStats.closed > 0 && <button onClick={handleArchive} className="flex items-center gap-2 px-3 py-1.5 text-sm bg-yellow-100 text-yellow-700 rounded-lg"><Archive size={16}/> Archive Closed</button>}
                                </div>
                                <div className="flex items-center gap-2">
                                     {cardFilter !== 'ALL' && <button onClick={() => setCardFilter('ALL')} className="flex items-center gap-2 px-3 py-1.5 text-sm bg-gray-200 rounded-lg"><FilterX size={16}/> Clear Filter</button>}
                                    <div className="relative"><Search size={18} className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" /><input type="text" placeholder="Search..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="p-2 pl-10 border rounded-lg w-full sm:w-64" /></div>
                                </div>
                            </div>
                        </div>

                        <div className="bg-white rounded-lg shadow-sm overflow-x-auto">
                            <table className="w-full text-left">
                                <thead className="bg-gray-100 border-b"><tr>{['Task ID', 'Description', 'Location', 'Assigned To', 'Status', 'Opened', 'Actions'].map(h => <th key={h} className="p-3 text-sm font-semibold text-gray-600 whitespace-nowrap">{h}</th>)}</tr></thead>
                                <tbody>
                                    {filteredTasks.map(c => ( <tr key={c.id} className="border-b hover:bg-gray-50 text-sm">
                                        <td className="p-3 text-gray-500 font-mono">{c.id}</td>
                                        <td className="p-3 text-gray-800 max-w-sm truncate" title={c.description}>{c.description}</td>
                                        <td className="p-3 text-gray-600 max-w-xs truncate">{[c.tower, c.floor, c.location].filter(Boolean).join(', ')}</td>
                                        <td className="p-3 text-gray-600">{c.assignedTo || 'N/A'}</td>
                                        <td className="p-3">
                                            <select value={c.status} onChange={(e) => handleStatusChange(c, e.target.value)} className="p-1 border rounded-lg bg-transparent text-sm" disabled={c.status === 'Closed'}>
                                                {listData.statuses.map(s => <option key={s} value={s}>{s}</option>)}
                                            </select>
                                        </td>
                                        <td className="p-3 text-gray-600">{c.createdAt ? new Date(c.createdAt).toLocaleDateString() : 'N/A'}</td>
                                        <td className="p-3">
                                            <div className="flex items-center gap-1">
                                                <ReminderManager task={c} db={db} setWhatsAppInfo={setWhatsAppInfo} isAdmin={isAdmin} />
                                                {isAdmin && <button onClick={() => handleEditTask(c)} className="p-2 text-blue-600 hover:bg-blue-100 rounded-full" title="Edit"><Edit size={16} /></button>}
                                                {isAdmin && <button onClick={() => handleDeleteTask(c.id)} className="p-2 text-red-600 hover:bg-red-100 rounded-full" title="Delete"><Trash2 size={16} /></button>}
                                            </div>
                                        </td>
                                    </tr> ))}
                                </tbody>
                            </table>
                             {filteredTasks.length === 0 && <div className="text-center p-8 text-gray-500">No tasks found.</div>}
                        </div>
                    </div>
                    {whatsAppInfo.isOpen && <WhatsAppMessageModal {...whatsAppInfo} onClose={() => setWhatsAppInfo({ isOpen: false })} />}
                    {commentModalInfo.isOpen && <ResolutionCommentModal {...commentModalInfo} onSave={handleCloseWithComment} onClose={() => setCommentModalInfo({ isOpen: false })} />}
                </div>
            );
        }

        // --- Reminder Manager ---
        function ReminderManager({ task, db, setWhatsAppInfo, isAdmin }) {
            const [currentTime, setCurrentTime] = useState(new Date()); const [isExtendModalOpen, setExtendModalOpen] = useState(false);
            useEffect(() => { const timer = setInterval(() => setCurrentTime(new Date()), 30000); return () => clearInterval(timer); }, []);
            const reminderConfig = { 1: { hours: 4, msg: (c) => `*1st Reminder*\n\nTask: *${c.id}*\nTo: *${c.assignedTo}*\nPassed TAT. Update needed.` }, 2: { hours: 4, msg: (c) => `*2nd Reminder*\n\nTask: *${c.id}*\nTo: *${c.assignedTo}*\nNo response. Update now.` }, 3: { hours: 2, msg: (c) => `*Final Reminder*\n\nTask: *${c.id}*\nTo: *${c.assignedTo}*\nFinal warning. Respond or escalate.` }, 4: { hours: 0, msg: (c) => `*Escalation*\n\nDear Mr. Mukesh Sir,\nIntervention needed for Task: *${c.id}* (${c.description}).` } };
            const handleSendReminder = async () => { const currentLevel = (task.remindersSent?.level || 0) + 1; const config = reminderConfig[currentLevel]; if (!config) return; const message = config.msg(task); setWhatsAppInfo({ isOpen: true, message, link: 'https://wa.me/919999999999' }); const docRef = doc(db, `artifacts/${appId}/public/data/complaints`, task.id); const nextDue = config.hours > 0 ? new Date(Date.now() + config.hours * 3600 * 1000).toISOString() : null; await updateDoc(docRef, { 'remindersSent.level': currentLevel, 'remindersSent.lastSent': new Date().toISOString(), 'nextReminderDue': nextDue }); };
            const handleExtendTat = async (minutes) => { const now = Date.now(); const currentDue = task.nextReminderDue ? new Date(task.nextReminderDue).getTime() : now; const newDueTime = new Date(Math.max(now, currentDue) + minutes * 60000); await updateDoc(doc(db, `artifacts/${appId}/public/data/complaints`, task.id), { nextReminderDue: newDueTime.toISOString() }); setExtendModalOpen(false); };
            if (task.status === 'Closed') return <span className="text-xs px-2 py-1 rounded-full bg-green-100 text-green-700">Completed</span>;
            if (!task.nextReminderDue) return <span className="text-xs px-2 py-1 rounded-full bg-gray-100">{task.status}</span>;
            const now = currentTime.getTime(); const dueTime = new Date(task.nextReminderDue).getTime();
            return ( <div className="flex items-center gap-1"> {now >= dueTime ? (<button onClick={handleSendReminder} disabled={!isAdmin} className="p-2 text-red-600 bg-red-100 rounded-full animate-pulse disabled:opacity-50 disabled:animate-none" title="Send Reminder"><MessageSquare size={16} /></button>) : (<div className="text-xs text-gray-500 flex items-center gap-1 bg-gray-100 px-2 py-1 rounded-full" title="Next reminder"><Clock size={14} /><span>{formatDuration(dueTime - now)}</span></div>)} {isAdmin && <button onClick={() => setExtendModalOpen(true)} className="p-2 text-blue-600 hover:bg-blue-100 rounded-full" title="Extend TAT"><Plus size={16}/></button>} {isExtendModalOpen && <ExtendTatModal onSave={handleExtendTat} onClose={() => setExtendModalOpen(false)} />} </div> );
        }
        
        // --- Modals ---
        function WhatsAppMessageModal({ message, link, onClose }) { useEffect(() => { navigator.clipboard.writeText(message).catch(err => console.error(err)); }, [message]); return ( <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"><div className="bg-white rounded-lg shadow-xl w-full max-w-md"><div className="p-4 border-b flex justify-between items-center"><h3 className="font-medium">Send via WhatsApp</h3><button onClick={onClose}><X size={20} /></button></div><div className="p-4"><p className="text-sm text-gray-600 mb-2">Message copied.</p><textarea readOnly value={message} className="w-full h-32 p-2 border rounded bg-gray-50 text-sm" /></div><div className="p-4 bg-gray-50 flex justify-end gap-3"><button onClick={onClose} className="px-4 py-2 border rounded-lg">Cancel</button><a href={`${link}?text=${encodeURIComponent(message)}`} target="_blank" rel="noopener noreferrer" onClick={onClose} className="px-4 py-2 bg-green-600 text-white rounded-lg">Open WhatsApp</a></div></div></div> ); }
        function ExtendTatModal({ onSave, onClose }) { const [minutes, setMinutes] = useState(15); return ( <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"><div className="bg-white rounded-lg shadow-xl w-full max-w-sm"><div className="p-4 border-b flex justify-between items-center"><h3 className="font-medium">Extend TAT</h3><button onClick={onClose}><X size={20} /></button></div><div className="p-4 space-y-4"><label className="text-sm">Add extra time (minutes):</label><input type="number" value={minutes} onChange={e => setMinutes(Number(e.target.value))} className="w-full p-2 border rounded-lg" /></div><div className="p-4 bg-gray-50 flex justify-end gap-3"><button onClick={onClose} className="px-4 py-2 border rounded-lg">Cancel</button><button onClick={() => onSave(minutes)} className="px-4 py-2 bg-blue-600 text-white rounded-lg">Extend</button></div></div></div> ); }
        function ResolutionCommentModal({ task, onSave, onClose }) { const [comment, setComment] = useState(''); return ( <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"><div className="bg-white rounded-lg shadow-xl w-full max-w-lg"><div className="p-4 border-b flex justify-between items-center"><h3 className="font-medium">Add Resolution Comment</h3><button onClick={onClose}><X size={20} /></button></div><div className="p-6"><p className="text-sm mb-2">Provide a comment before closing the task.</p><textarea value={comment} onChange={(e) => setComment(e.target.value)} className="w-full h-24 p-2 border rounded-lg" placeholder="Resolution details..."></textarea></div><div className="p-4 bg-gray-50 flex justify-end gap-3"><button onClick={onClose} className="px-4 py-2 border rounded-lg">Cancel</button><button onClick={() => onSave(task, comment)} disabled={!comment.trim()} className="px-4 py-2 bg-blue-600 text-white rounded-lg disabled:bg-gray-400">Save & Close</button></div></div></div> ); }

        // --- Main App Controller ---
        function App() {
            const [user, setUser] = useState(null); const [auth, setAuth] = useState(null); const [isLoading, setIsLoading] = useState(true);
            useEffect(() => { const app = initializeApp(firebaseConfig); const authInstance = getAuth(app); setAuth(authInstance); const unsubscribe = onAuthStateChanged(authInstance, (user) => { setUser(user); setIsLoading(false); }); return () => unsubscribe(); }, []);
            if (isLoading) { return <div className="flex items-center justify-center h-screen"><div className="text-xl font-semibold">Loading App...</div></div>; }
            return user ? <TaskTool user={user} auth={auth} /> : <LoginScreen auth={auth} />;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>

</body>
</html>
